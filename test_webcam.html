<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Webcam Test</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        video { border: 2px solid black; }
        #status { margin-top: 1rem; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Webcam to Backend Test</h1>
    <video id="webcam" width="640" height="480" autoplay></video>
    <div id="status">Status: Not Connected</div>

    <script>
        const video = document.getElementById('webcam');
        const statusDiv = document.getElementById('status');
        const ws = new WebSocket('ws://127.0.0.1:8000/api/v1/gym/ws');

        // Handle WebSocket connection open
        ws.onopen = () => {
            console.log('WebSocket connection established.');
            statusDiv.textContent = 'Status: Connected! Streaming frames...';

            // Send a frame every 100ms (10 frames per second)
            setInterval(() => {
                sendFrame();
            }, 100);
        };

        // Handle messages received from the server
        ws.onmessage = (event) => {
            console.log('Message from server:', event.data);
        };

        // Handle WebSocket errors
        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            statusDiv.textContent = 'Status: Connection Error!';
        };

        // Function to get webcam access
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                video.srcObject = stream;
            })
            .catch((err) => {
                console.error("Error accessing webcam:", err);
                statusDiv.textContent = 'Error: Could not access webcam.';
            });

        // Function to capture a frame and send it
        const sendFrame = () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert the canvas image to a binary Blob
            canvas.toBlob((blob) => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(blob); // Send the binary data
                }
            }, 'image/jpeg'); // Send as JPEG
        };
    </script>
</body>
</html>
